
ALTER DATABASE [tpch] SET COMPATIBILITY_LEVEL = 140
GO

USE [tpch]
GO
CREATE NONCLUSTERED COLUMNSTORE INDEX [NCCIX_LINEITEM] ON [dbo].[LINEITEM]
(
	[L_ORDERKEY],
	[L_PARTKEY],
	[L_SUPPKEY],
	[L_LINENUMBER],
	[L_QUANTITY],
	[L_EXTENDEDPRICE],
	[L_DISCOUNT],
	[L_TAX],
	[L_RETURNFLAG],
	[L_LINESTATUS],
	[L_SHIPDATE],
	[L_COMMITDATE],
	[L_RECEIPTDATE],
	[L_SHIPINSTRUCT],
	[L_SHIPMODE],
	[L_COMMENT]
)WITH (DROP_EXISTING = OFF, COMPRESSION_DELAY = 0) ON [PRIMARY]
GO



EXEC sp_executesql 
N'SELECT TOP 100 L_PARTKEY FROM LINEITEM WHERE L_SHIPDATE BETWEEN @param1 AND @param2 GROUP BY L_PARTKEY ORDER BY MAX(L_ORDERKEY) DESC', 
N'@param1 date, @param2 date',
@param1 = '1998-08-10',
@param2 = '1998-08-10'
GO

-- 同一のクエリを 3 回実行しているが、3 回目の実行で実行プランに変化がある (ワークスペースメモリーが最適化されて実行される)
EXEC sp_executesql 
N'SELECT TOP 100 L_PARTKEY FROM LINEITEM WHERE L_SHIPDATE BETWEEN @param1 AND @param2 GROUP BY L_PARTKEY ORDER BY MAX(L_ORDERKEY) DESC', 
N'@param1 date, @param2 date',
@param1 = '1998-01-01',
@param2 = '2001-12-31'
GO 3